##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
#   http://metasploit.com/framework/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
  Rank = ManualRanking

  include Msf::Exploit::CmdStagerEcho

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Test for the CmdStagerBusybox',
      'Description'    => %q{
          Test for the CmdStagerBusybox.
      },
      'Author'         =>
        [
          'joev <jvennix[at]rapid7.com>',  #Who found this vuln?
          'juan vazquez'
        ],
      'License'        => MSF_LICENSE,
      'Arch'           => ARCH_X86,
      'Platform'       => 'linux',
      'Targets'        =>
        [
          [ 'Automatic', { } ],
        ],
      'DefaultTarget'  => 0,
      'DisclosureDate' => 'Sep 11 2013'))
  end

  def execute_command(cmd, opts)
    File.open(@output, "ab") {|f|
      f.write(cmd)
      f.write("\nMSFLINE\n")
    }
  end

  def exploit
    @output = "/tmp/test1.txt"
    print_status("Executing CMD Stager with default linemax, dumping to #{@output}")
    execute_cmdstager()
    @output = "/tmp/test2.txt"
    print_status("Executing CMD Stager with default linemax, dumping to #{@output}")
    execute_cmdstager({:linemax => 100})
  end
end
